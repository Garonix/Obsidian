- 首次读取 conf.AppYaml (嵌入的默认配置):

- backend/init/viper/viper.go (startLine: 30, endLine: 33): 首先，代码尝试将 conf.AppYaml 的内容 (这是一个嵌入到程序中的 YAML 文件，位于 cmd/server/conf/app.yaml (startLine: 1, endLine: 19)) 反序列化到 config 变量中。 这提供了一组默认配置。

- 如果反序列化失败，程序会panic。

- 根据运行模式选择配置来源:

- backend/init/viper/viper.go (startLine: 34, endLine: 56): 接下来，代码检查 config.System.Mode。

- 如果 mode 是 "dev" 并且存在 /opt/1panel/conf/app.yaml 文件: 代码使用 viper 库从 /opt/1panel/conf/app.yaml 文件中读取配置。 这允许在开发环境中通过外部文件覆盖默认配置。

- 否则 (非 "dev" 模式或 /opt/1panel/conf/app.yaml 不存在): 代码从环境变量中加载配置 (使用 loadParams 函数) 并使用嵌入的 conf.AppYaml 作为配置。

- 覆盖配置值 (仅在 "dev" 模式下):

- backend/init/viper/viper.go (startLine: 66, endLine: 88): 如果运行在 "dev" 模式下，并且成功从 /opt/1panel/conf/app.yaml 加载了配置，那么会使用从该文件读取的 serverConfig 中的值来覆盖之前设置的 baseDir, port, version, username, password, entrance, 和 language。

- 设置全局配置:

- backend/init/viper/viper.go (startLine: 90, endLine: 108): 最后，将所有配置值赋给全局变量 global.CONF。

为什么需要 app.yaml 和额外的配置？

- 默认配置: 嵌入的 conf.AppYaml 提供了一组默认配置，确保程序在没有任何外部配置的情况下也能运行。

- 开发环境覆盖: /opt/1panel/conf/app.yaml 允许在开发环境中轻松覆盖默认配置，例如使用不同的端口、数据库设置等，而无需修改嵌入的默认配置或环境变量。

- 环境变量配置: 环境变量用于在生产环境中配置应用程序，因为它们可以在不修改代码或配置文件的情况下进行设置。

总结:

这种设计允许程序具有合理的默认配置，同时支持在不同环境中使用不同的配置方式。 在开发环境中，可以使用 /opt/1panel/conf/app.yaml 覆盖默认配置，而在生产环境中，可以使用环境变量。 嵌入的 conf.AppYaml 确保程序始终具有可用的配置。